# A github workflow to build custom android common kernels with specified parameters
# Copyright (C) 2025 chickendrop89
#
# Licensed under GPL v3 or later

name: Build Android Common Kernel

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      ack_branch:
        description: 'Android-common-kernel branch (e.g. common-android13-5.15)'
        required: true
        default: 'common-android13-5.15'
        type: string
      custom_kernel_repo:
        description: 'Custom kernel repository'
        required: true
        default: 'https://github.com/chickendrop89/device_xiaomi_unified-kernel'
        type: string
      custom_kernel_repo_branch:
        description: 'Custom kernel repository branch'
        required: true
        default: 'android13-5.15-lts'
        type: string
      use_latest_clang:
        description: 'Use the latest clang prebuilts (Check README!)'
        required: true
        default: true
        type: boolean
      anykernel_url_plus_branch:
        description: 'Space-separated AnyKernel3 fork URL + (Optional) Branch'
        required: true
        default: 'https://github.com/chickendrop89/AnyKernel3'
        type: string
      kernel_image_type:
        description: 'Kernel image to package (Image.gz, Image.lz4, etc)'
        required: true
        default: 'Image'
        type: string
      fast_build:
        description: 'Instruct tools to perform a Fast Build'
        required: true
        default: true
        type: boolean
      use_kleaf:
        description: 'Use the kleaf build system instead of build script'
        required: true
        default: false
        type: boolean
      extra_args:
        description: 'Extra arguments that will be passed to build system/script'
        required: false
      build_configs:
        description: 'Space-separated list of build configurations'
        required: true
        default: 'build.config.gki.aarch64.chickernel build.config.gki.aarch64.chickernel.ksun build.config.gki.aarch64.chickernel.ksun.susfs'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BUILD_CONFIGS: ${{ github.event.inputs.build_configs }}
      IMAGE_TYPE: ${{ github.event.inputs.kernel_image_type }}
      ACK_BRANCH: ${{ github.event.inputs.ack_branch }}
      COMMON_REPO: ${{ github.event.inputs.custom_kernel_repo }}
      COMMON_REPO_BRANCH: ${{ github.event.inputs.custom_kernel_repo_branch }}
      AK3_GIT_URL_PLUS_BRANCH: ${{ github.event.inputs.anykernel_url_plus_branch }}
      AK3_DIR: ${{ github.workspace }}/kernel-build/anykernel3
      FINAL_DIR: ${{ github.workspace }}/kernel-build/final_images

    steps:
      - name: Validate inputs
        run: |
          AK3_GIT_URL=$(echo "${AK3_GIT_URL_PLUS_BRANCH}" | awk '{print $1}')
          AK3_GIT_BRANCH=$(echo "${AK3_GIT_URL_PLUS_BRANCH}" | awk '{print $2}')
          
          echo "AK3_GIT_URL=${AK3_GIT_URL}" >> ${GITHUB_ENV}
          echo "AK3_GIT_BRANCH=${AK3_GIT_BRANCH}" >> ${GITHUB_ENV}

          validate_url() {
            if [[ ! "$1" =~ ^https://.+/.+/.+$ ]]; then
              echo "Invalid URL: $1"
              exit 1
            fi
          }
          validate_url ${COMMON_REPO}
          validate_url ${AK3_GIT_URL}

          validate_single_word() {
            if [[ "$1" =~ [[:space:]] ]]; then
              echo "::error::Invalid $2: $1"
              exit 1
            fi
          }

          validate_single_word "${ACK_BRANCH}" "Android-common-kernel branch"
          validate_single_word "${COMMON_REPO_BRANCH}" "Custom Kernel repo branch"
          if [ ! -z "${AK3_GIT_BRANCH}" ]; then
            validate_single_word "${AK3_GIT_BRANCH}" "AnyKernel3 fork branch"
          fi
          validate_single_word "${IMAGE_TYPE}" "Kernel image type"

      - name: Setup build workspace and a local manifest
        env:
          USE_LATEST_CLANG: ${{ github.event.inputs.use_latest_clang }}
          CUSTOM_MANIFEST: .repo/local_manifests/custom.xml
        run: |
          REPO_SOURCE=$(echo ${COMMON_REPO} | cut -d'/' -f3)
          REPO_OWNER=$(echo ${COMMON_REPO} | cut -d'/' -f4)
          REPO_NAME=$(echo ${COMMON_REPO} | cut -d'/' -f5)

          mkdir kernel-build && cd $_
          mkdir -p .repo/local_manifests

          mecho() {
            echo "$1" >> "${CUSTOM_MANIFEST}"
          }

          mecho '<?xml version="1.0" encoding="UTF-8"?>'
          mecho '<manifest>'
          mecho "  <remote name=\"common-repo\" fetch=\"https://${REPO_SOURCE}/${REPO_OWNER}\" />"
          mecho ''
          mecho '  <remove-project name="kernel/common" />'
          mecho "  <project path=\"common\" name=\"${REPO_NAME}\" remote=\"common-repo\" revision=\"${COMMON_REPO_BRANCH}\" >"
          mecho '    <linkfile src="." dest=".source_date_epoch_dir" />'
          mecho '  </project>'

          if [ "${USE_LATEST_CLANG}" = true ]; then
            mecho '  <remove-project name="platform/prebuilts/clang/host/linux-x86" />'
            mecho '  <project path="prebuilts/clang/host/linux-x86" name="platform/prebuilts/clang/host/linux-x86" revision="main" clone-depth="1" />'
          fi

          mecho '</manifest>'

      - name: Download build utilities
        working-directory: kernel-build
        run: |
          if [ -z "${AK3_GIT_BRANCH}" ]
            then git clone --depth=1 ${AK3_GIT_URL} "${AK3_DIR}"
            else git clone --depth=1 ${AK3_GIT_URL} "${AK3_DIR}" -b ${AK3_GIT_BRANCH}
          fi

          mkdir -p ~/.bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
          chmod a+rx ~/.bin/repo
          echo "${HOME}/.bin" >> ${GITHUB_PATH}

      - name: Clean up container
        uses: rokibhasansagar/slimhub_actions@main

      - name: Initialize the manifest, and sync
        working-directory: kernel-build
        run: |
          repo init \
            --no-tags \
            --depth=1 \
            --dissociate \
            -u https://android.googlesource.com/kernel/manifest \
            -b ${ACK_BRANCH}

          repo sync \
            --no-tags \
            --clone-bundle \
            --current-branch \
            --optimized-fetch \
            --force-sync \
            --fetch-submodules \
            -j$(nproc --all)

      - name: Verify Git repository
        working-directory: kernel-build/common
        run: |
          if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
            echo "‚ùå Error: Not a valid Git repository in $(pwd)"
            exit 1
          fi
          echo "‚úÖ Git repository verified."

      - name: Update KernelSU to latest stable
        working-directory: kernel-build/common
        run: |
          echo "üîÑ Updating KernelSU to latest stable..."
          if [ -d "drivers/kernelsu" ]; then
            rm -rf drivers/kernelsu
          fi
          git clone --depth=1 https://github.com/tiann/KernelSU.git drivers/kernelsu
          if [ -f drivers/kernelsu/kernel.patch ]; then
            git apply drivers/kernelsu/kernel.patch || {
              echo "‚ö†Ô∏è KernelSU patch may already be applied or conflicts. Continuing..."
            }
            git add .
            git commit -m "Apply latest KernelSU patch" || echo "‚úÖ No changes to commit for KernelSU."
          fi
          echo "‚úÖ KernelSU updated to latest stable release."

      - name: Apply latest stable SUSFS patch (android13-5.15)
        working-directory: kernel-build/common
        run: |
          echo "üîÑ Applying latest stable SUSFS patch for android13-5.15..."

          # Skip patching if build config includes 'susfs'
          if [[ "${BUILD_CONFIGS}" == *"susfs"* ]]; then
            echo "‚ö†Ô∏è SUSFS detected in build config (${BUILD_CONFIGS}). Skipping patch application."
            exit 0
          fi

          # Check for existing SUSFS patches
          echo "üîç Checking for existing SUSFS patches..."
          SUSFS_COMMITS=$(git log --oneline --grep="susfs" --grep="SUSFS" || true)
          if [ -n "$SUSFS_COMMITS" ]; then
            echo "‚ö†Ô∏è Found existing SUSFS-related commits:"
            echo "$SUSFS_COMMITS"
            echo "üîÑ Attempting to revert SUSFS-related changes..."
            LATEST_SUSFS_COMMIT=$(git log --oneline --grep="susfs" --grep="SUSFS" -n 1 | cut -d' ' -f1)
            if [ -n "$LATEST_SUSFS_COMMIT" ]; then
              git revert --no-edit "$LATEST_SUSFS_COMMIT" || {
                echo "‚ö†Ô∏è Failed to revert SUSFS commit. Assuming kernel is ready for new patch."
              }
              echo "‚úÖ Reverted previous SUSFS commit: $LATEST_SUSFS_COMMIT"
            fi
          else
            echo "‚úÖ No existing SUSFS patches found."
          fi

          # Fetch the latest SUSFS release
          SUSFS_LATEST=$(curl -s https://api.github.com/repos/SUSFS/SUSFS/releases/latest | grep -Po '"tag_name": "\K.*?(?=")' || true)
          if [ -z "$SUSFS_LATEST" ]; then
            echo "‚ö†Ô∏è Failed to fetch latest SUSFS release tag. Skipping patch."
            exit 0
          fi
          echo "üì¶ Latest SUSFS release: $SUSFS_LATEST"

          # Search for the SUSFS patch
          PATCH_FOUND=false
          for DIR in "patches/android13-5.15" "patches/5.15" "patches/common"; do
            SUSFS_PATCH_URL="https://raw.githubusercontent.com/SUSFS/SUSFS/${SUSFS_LATEST}/${DIR}/susfs-${SUSFS_LATEST}.patch"
            echo "üîç Checking ${SUSFS_PATCH_URL}"
            if curl --silent --fail -o susfs.patch "${SUSFS_PATCH_URL}"; then
              echo "‚úÖ Found SUSFS patch at ${DIR}"
              PATCH_FOUND=true
              break
            fi
          done

          if [ "$PATCH_FOUND" = false ]; then
            echo "‚ö†Ô∏è SUSFS patch not found. Skipping patch application."
            exit 0
          fi

          # Apply the new SUSFS patch
          echo "üîß Checking if SUSFS patch can be applied..."
          if git apply --check susfs.patch >/dev/null 2>&1; then
            echo "üîß Applying SUSFS patch..."
            if git apply susfs.patch; then
              echo "‚úÖ SUSFS ${SUSFS_LATEST} patch applied successfully."
              git add .
              git commit -m "Apply SUSFS ${SUSFS_LATEST} patch" || echo "‚úÖ No changes to commit for SUSFS."
            else
              echo "‚ùå Failed to apply SUSFS patch cleanly."
              exit 1
            fi
          else
            echo "‚ö†Ô∏è SUSFS patch cannot be applied cleanly (possible conflicts or already applied)."
            git apply --reject susfs.patch || {
              echo "‚ùå Patch application failed. See *.rej files for conflicts."
              ls *.rej || true
              exit 1
            }
            echo "‚ö†Ô∏è Patch applied with conflicts. Review *.rej files in $(pwd)"
            git add .
            git commit -m "Apply SUSFS ${SUSFS_LATEST} patch with conflicts" || echo "‚úÖ No changes to commit for SUSFS."
          fi

      - name: Upload SUSFS conflict files (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: susfs-conflicts
          path: kernel-build/common/*.rej
          if-no-files-found: ignore

      - name: Build, and process the kernel(s)
        working-directory: kernel-build
        env:
          EXTRA_ARGS: ${{ github.event.inputs.extra_args }}
          FAST_BUILD: ${{ github.event.inputs.fast_build }}
          USE_KLEAF: ${{ github.event.inputs.use_kleaf }}
          OUT_DIR: ${{ github.workspace }}/kernel-build/out
          OUT_BAZEL_DIR: ${{ github.workspace }}/kernel-build/bazel-bin/common
        run: |
          mkdir -p "${FINAL_DIR}"

          for config in ${BUILD_CONFIGS}; do
            echo "üî® Building kernel with config: ${config}"

            # Validate build config file
            if [ ! -f "common/${config}" ]; then
              echo "‚ùå Error: Build config common/${config} not found!"
              exit 1
            fi

            # Set up output directory for this config
            CONFIG_OUT_DIR="${OUT_DIR}/${config}"
            mkdir -p "${CONFIG_OUT_DIR}"

            if [ "${USE_KLEAF}" = true ]; then
              # Build using Kleaf (Bazel-based build system)
              echo "üöÄ Using Kleaf build system..."
              bazel build //common:kernel_aarch64_dist \
                --config="${config}" \
                --dist_dir="${CONFIG_OUT_DIR}" \
                ${EXTRA_ARGS} || {
                echo "‚ùå Failed to build kernel with Kleaf for config ${config}"
                exit 1
              }
              cp -v "${OUT_BAZEL_DIR}/kernel_aarch64_dist/${IMAGE_TYPE}" "${CONFIG_OUT_DIR}/" || {
                echo "‚ùå Failed to copy kernel image ${IMAGE_TYPE}"
                exit 1
              }
            else
              # Build using traditional build script
              echo "üöÄ Using traditional build script..."
              if [ "${FAST_BUILD}" = true ]; then
                echo "‚ö° Performing fast build..."
                ./build/build.sh \
                  -j$(nproc --all) \
                  BUILD_CONFIG="common/${config}" \
                  OUT_DIR="${CONFIG_OUT_DIR}" \
                  ${EXTRA_ARGS} || {
                  echo "‚ùå Failed to build kernel with build.sh for config ${config}"
                  exit 1
                }
              else
                ./build/build.sh \
                  -j$(nproc --all) \
                  BUILD_CONFIG="common/${config}" \
                  OUT_DIR="${CONFIG_OUT_DIR}" \
                  ${EXTRA_ARGS} || {
                  echo "‚ùå Failed to build kernel with build.sh for config ${config}"
                  exit 1
                }
              fi
              cp -v "${CONFIG_OUT_DIR}/kernel/${IMAGE_TYPE}" "${CONFIG_OUT_DIR}/" || {
                echo "‚ùå Failed to copy kernel image ${IMAGE_TYPE}"
                exit 1
              }
            fi

            # Package the kernel with AnyKernel3
            echo "üì¶ Packaging kernel with AnyKernel3..."
            cp "${CONFIG_OUT_DIR}/${IMAGE_TYPE}" "${AK3_DIR}/Image"
            cd "${AK3_DIR}"
            zip -r9 "${FINAL_DIR}/${config}-${IMAGE_TYPE}-kernel.zip" . -x ".git/*" -x "*.md" || {
              echo "‚ùå Failed to create kernel ZIP for config ${config}"
              exit 1
            }
            cd "${GITHUB_WORKSPACE}/kernel-build"
            echo "‚úÖ Kernel package created: ${FINAL_DIR}/${config}-${IMAGE_TYPE}-kernel.zip"
          done

          echo "üéâ All kernels built and packaged successfully!"

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-zips
          path: ${{ github.workspace }}/kernel-build/final_images/*.zip
          if-no-files-found: error
